<!DOCTYPE html>
<html lang="de">
  <head>
    <title>find den Fehler</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nothing+You+Could+Do&display=swap"
      rel="stylesheet"
    />
    <meta charset="UTF-8" />
    <meta name="theme-color" content="#121212" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="papaparse.min.js"></script>
    <style>
      /* Farben */
      :root {
        --bg: #f5f5f5;
        --fg: #222;
        --card-bg: #fefefe;
        --card-border: #929292;
        --button-bg: rgb(183, 183, 183);
        --error: rgb(255, 48, 48);
        --success: #388e3c;
        --shadow: rgba(0, 0, 0, 0.1);
        --hover-bg: rgb(204, 204, 204);
        --bg-gradient: linear-gradient(
          176deg,
          var(--hover-bg) 0%,
          rgba(204, 204, 204, 0.5) 55%,
          var(--hover-bg) 96%
        );
      }

      [data-theme="dark"] {
        --bg: #121212;
        --fg: #dfdfdf;
        --card-bg: #2c2c2c;
        --card-border: #606060;
        --button-bg: #454545;
        --hover-bg: rgb(90, 90, 90);
        --shadow: rgba(255, 255, 255, 0.1);
        --bg-gradient: linear-gradient(
          176deg,
          var(--hover-bg) 0%,
          rgba(90, 90, 90, 0.6) 55%,
          var(--hover-bg) 96%
        );
      }

      /* Body */
      body {
        background: var(--bg);
        color: var(--fg);
        font-family: system-ui, sans-serif;
        margin: auto;
        padding: 0px;
        transition: background 0.5s, color 0.5s;
      }

      /* Kopfzeile */
      header {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        border-bottom: 1px solid var(--card-border);
        box-shadow: 0 1px 4px var(--shadow);
        background: var(--bg);
        transition: transform 0.5s ease;
      }

      header.hide {
        transform: translateY(-100%);
      }

      /* Logo */
      .logoContainer {
        display: flex;
        flex-basis: 50px;
        width: 50px;
        height: 50px;
        margin: auto 0;
        left: 0;
        gap: 1em;
      }

      .logoText {
        display: flex;
        flex-wrap: nowrap;
        flex-basis: 250px;
        align-items: center;
        justify-content: center;
        margin-left: 0;
      }

      .logoText h1 {
        font-family: "Nothing You Could Do", cursive;
        font-size: 28px;
        color: var(--bg);
        padding: 0;
        margin: 0;
        margin-right: auto;
      }

      .logo {
        width: 40px;
        height: 40px;
        margin-left: 10px;
        opacity: 0.8;
      }

      .light-logo {
        display: none;
      }

      .dark-logo {
        display: block;
      }

      [data-theme="dark"] .light-logo {
        display: block;
      }

      [data-theme="dark"] .dark-logo {
        display: none;
      }

      /* Kopfzeile - Eingaben */
      .controls {
        display: flex;
        gap: 3px;
        background: var(--bg-gradient);
      }

      .inputContainer {
        display: flex;
        flex-wrap: wrap;
        margin: 0.7em auto;
        gap: 3px;
      }

      select,
      input[type="text"] {
        padding: 7px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid var(--card-border);
        background-color: var(--card-bg);
        color: var(--fg);
      }

      select option {
        background-color: var(--card-bg);
      }

      select option:checked,
      select option:hover {
        background-color: var(--hover-bg);
      }

      select:focus,
      button {
        cursor: pointer;
        outline: none;
      }

      input:focus {
        outline: none;
      }

      /* Kopfzeile - Men√º */
      .menu-wrapper {
        display: flex;
        flex-basis: 300px;
        align-items: center;
        justify-content: right;
      }

      .menu-toggle {
        display: flex;
        background-color: var(--button-bg);
        width: 40px;
        height: 40px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        margin: 5px;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 12px var(--shadow);
        transition: transform 0.5 ease;
      }

      .menu-toggle:hover {
        filter: brightness(105%);
        box-shadow: 0 2px 4px var(--shadow);
      }

      .settingsIcon {
        height: 25px;
        width: 25px;
        transition: transform 0.8 ease;
      }

      .settingsIcon:hover {
        animation: rotateImage 5s infinite linear;
      }

      @keyframes rotateImage {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(359deg);
        }
      }

      .menu-content {
        display: none;
        position: absolute;
        right: 5px;
        top: 5px;
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        box-shadow: 0px 8px 16px var(--shadow);
        padding: 0;
        border-radius: 6px;
        z-index: 2;
        min-width: 160px;
        overflow: hidden;
      }

      .menu-wrapper.open .menu-content {
        display: block;
      }

      .menu-content button {
        display: block;
        width: 100%;
        padding: 8px;
        background: none;
        border: none;
        text-align: left;
        font-size: 18px;
        cursor: pointer;
        color: var(--fg);
      }

      .menu-content button:hover {
        background-color: var(--hover-bg);
      }

      /* Hauptfenster */
      .container {
        display: flex;
        flex-direction: column;
        gap: 1em;
        margin-top: 1.5em;
        align-items: center;
      }

      /* Card */
      .card {
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1em;
        margin-bottom: 1em;
        width: 80vw;
        max-width: 1000px;
        min-width: 350px;
        min-height: 200px;
        box-shadow: 0 2px 12px var(--shadow);
        transition: background 0.5s, border 0.5s;
      }

      .card h5,
      .card h4,
      .card h3 {
        margin: 2px 0;
      }
      .card p {
        margin: 0;
      }

      /* Card - Kopfzeile */
      .cardheader {
        display: flex;
        flex-wrap: wrap;
        background: var(--bg-gradient);
        padding: 0.7em 0.5em 0.5em 0.5em;
        align-items: center;
        justify-content: space-between;
        border-top-left-radius: 1em;
        border-top-right-radius: 1em;
        border-bottom: 1px solid var(--card-border);
        box-shadow: 0 1px 4px var(--shadow);
      }

      .herstellerImage {
        max-height: 30px;
      }

      .cardHeaderTyp {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        max-height: 40px;
        justify-content: center;
        font-size: larger;
        gap: 6px;
      }

      .cardHeaderTyp :nth-child(2) {
        color: var(--error);
        font-weight: 700;
        font-size: medium;
        align-self: flex-end;
      }

      /* Card - Inhalt */
      .cardContent {
        display: flex;
        flex-direction: row;
        gap: 1em;
        margin: 1em;
      }

      .errorDescription {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 0.7em;
        justify-content: center;
      }

      .errorDescription p {
        margin-left: 5px;
      }

      .typImage {
        max-width: 150px;
      }

      /* Scroll nach oben Button */
      #scrollTopBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        opacity: 0;
        align-items: center;
        justify-content: center;
        background-color: var(--card-border);
        border: 1px solid var(--card-border);
        border-radius: 50%;
        width: 48px;
        height: 48px;
        cursor: pointer;
        box-shadow: 0 2px 6px var(--shadow);
        transition: opacity 0.3s ease-in-out;
      }

      #scrollTopBtn.show {
        display: flex;
        opacity: 0.6;
      }

      #scrollTopBtn.show :first-child {
        opacity: 0.5;
        width: 38px;
        height: 33px;
        padding-bottom: 5px;
      }

      /* Benachrichtigungs Fenster */
      #statusMessage {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 500;
        z-index: 999;
        opacity: 0;
        transition: opacity 0.6s ease, transform 0.6s ease;
        box-shadow: 0 2px 6px var(--shadow);
        pointer-events: none;
      }

      #statusMessage.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      #statusMessage.success {
        background-color: #c8e6c9;
        color: var(--success);
        border: 1px solid var(--success);
      }

      #statusMessage.error {
        background-color: #ffcdd2;
        color: var(--error);
        border: 1px solid var(--error);
      }

      @media (max-width: 650px) {
        /* Kopfzeile - Eingaben */
        .controls {
          display: grid;
          gap: 2px;
          grid-template-columns: 50px auto 50px;
          grid-template-rows: 50px auto;
          grid-template-areas:
            "logo logotext menue"
            "controls controls controls";
        }

        .logoContainer {
          justify-content: left;
          grid-area: logo;
        }

        .logo {
          margin: auto;
        }

        .logoText {
          grid-area: logotext;
          margin: auto;
        }

        .logoText h1 {
          margin: 0;
        }

        .inputContainer {
          grid-area: controls;
          padding: 0 6px;
          margin: 2px 0 8px 0;
        }
        .menu-wrapper {
          justify-content: right;
          grid-area: menue;
        }

        .menu-toggle {
          height: 35px;
          width: 35px;
          margin: auto 6px auto 0;
        }

        .settingsIcon {
          width: 18px;
          height: 18px;
        }

        /* Hauptfenster */
        .container {
          gap: 0.5em;
          margin-top: 1em;
        }

        /* Card */
        .card {
          border-radius: 1em;
          margin-bottom: 1em;
          width: 96vw;
          min-width: 300px;
        }

        .cardContent {
          flex-wrap: wrap;
          flex-direction: column-reverse;
          align-items: center;
          gap: 0, 5em;
          margin: 1em 0.5em;
        }

        .errorDescription {
          gap: 0.5em;
        }

        .errorDescription p {
          margin-left: 3px;
        }

        .typImage {
          max-width: 120px;
        }
      }
    </style>
  </head>
  <body data-theme="light">
    <!-- Benachrichtigungs Fenster -->
    <div id="statusMessage" class="hidden"></div>

    <!-- Kopfzeile -->
    <header id="siteHeader">
      <div class="controls">
        <div class="logoContainer">
          <img
            src="images/icons/icon-512-blank.webp"
            alt="Logo"
            class="logo light-logo"
          />
          <img
            src="images/icons/dark/icon-512-blank.webp"
            alt="Logo"
            class="logo dark-logo"
          />
        </div>

        <div class="logoText">
          <h1>find den Fehler</h1>
        </div>

        <div class="inputContainer">
          <!--Fehlercode Suchfeld -->
          <input
            style="flex-grow: 2;"
            type="text"
            id="searchInput"
            placeholder="Suche nach Fehler-Code‚Ä¶"
          />

          <!-- Hersteller Auswahl -->
          <select id="herstellerFilter" style="flex-grow: 1;">
            <option value="">Alle Hersteller</option>
          </select>

          <!-- Typ Auswahl -->
          <select id="typFilter" style="flex-grow: 1;">
            <option value="">Alle Typen</option>
          </select>
        </div>

        <!-- Men√º -->
        <div class="menu-wrapper" id="optionDropdown">
          <!-- Men√º Button -->
          <button class="menu-toggle" id="menuToggle">
            <img
              class="theme-image settingsIcon"
              id="settingsIcon"
              src="images/icons/settings_dark.png"
              alt="Men√º"
            />
          </button>

          <!-- Men√º Inhalt -->
          <div class="menu-content">
            <button id="csvLoadBtn">üìÑ Fehlerliste laden</button>
            <button id="themeToggleBtn">üåì Dark / Light</button>
            <button id="resetBtn">üóëÔ∏è Zur√ºcksetzen</button>
            <input
              type="file"
              id="csvInput"
              accept=".csv"
              style="display: none;"
            />
          </div>
        </div>
      </div>
    </header>

    <!-- Hauptfenster -->
    <main id="container" class="container"></main>

    <!-- Scroll nach oben Button -->
    <button id="scrollTopBtn" title="Nach oben">
      <img src="images/icons/arrow-up.png" alt="Up" />
    </button>

    <!-- Funktionen -->
    <script>
      // Zeigt Benachrichtigungs Fenster
      function showStatusMessage(text, type = "success", timeout = 4000) {
        const msgBox = document.getElementById("statusMessage");
        msgBox.innerHTML = (type === "success" ? "‚úÖ " : "‚ö†Ô∏è ") + text;
        msgBox.className = `show ${type}`;
        setTimeout(() => {
          msgBox.className = msgBox.className.replace("show", "");
        }, timeout);
      }

      function debounce(fn, delay = 300) {
        let timer;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Wandelt CSV (Fehlerliste) um gibt sortierte zeilen aus
      function parseCSV(text) {
        const result = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
        });
        return result.data.map((row) => ({
          hersteller: (row["Hersteller"] || "").trim(),
          typ: (row["Typ"] || "").trim(),
          code: (row["Code"] || "").trim(),
          fehler: (row["Fehler"] || "").trim(),
          ursache: (row["Ma√ünahme"] || "").trim(),
          infos: (row["Info"] || "").trim(),
          weitere: (row["Weitere"] || "").trim(),
          kategorie: (row["Kategorie"] || "").trim(),
        }));
      }

      // Bef√ºllt die Dropdown men√ºs
      function fillDropdowns(data) {
        const herstellerSet = new Set();
        const typSet = new Set();
        data.forEach((d) => {
          herstellerSet.add(d.hersteller);
          typSet.add(d.typ);
        });

        herstellerFilter.innerHTML =
          '<option value="">Alle Hersteller</option>' +
          [...herstellerSet]
            .sort()
            .map((h) => `<option value="${h}">${h}</option>`)
            .join("");

        typFilter.innerHTML =
          '<option value="">Alle Typen</option>' +
          [...typSet]
            .sort()
            .map((t) => `<option value="${t}">${t}</option>`)
            .join("");
      }

      // Rendert die Seite
      function renderDaten() {
        const suchtext = searchInput.value.trim().toLowerCase();
        const hersteller = herstellerFilter.value.toLowerCase();
        const typ = typFilter.value.toLowerCase();

        container.innerHTML = "";

        // Wendet Filter an
        daten
          .filter(
            (item) =>
              (suchtext === "" ||
                item.code.trim().toLowerCase() === suchtext) &&
              (hersteller === "" ||
                item.hersteller.trim().toLowerCase() === hersteller) &&
              (typ === "" || item.typ.trim().toLowerCase() === typ)
          )
          // Erstellt f√ºr jeden treffer eine Card
          .forEach((item) => {
            const card = document.createElement("div");
            const typImageName =
              item.typ.toLowerCase().replace(/\s+/g, "_") + ".png";
            const typImagePath = `images/typen/${typImageName}`;
            const herstellerImageName =
              item.hersteller.toLowerCase().replace(/\s+/g, "_") + ".png";
            const herstellerImagePath = `images/hersteller/${herstellerImageName}`;

            card.className = "card";
            card.innerHTML = `
              <div class="cardheader">
                <div class="herstellerImageContainer">                  
                  <img
                    class="herstellerImage theme-image"
                    src="${herstellerImagePath}"
                    data-theme-light="images/hersteller/${herstellerImageName}"
                    data-theme-dark="images/hersteller/dark/${herstellerImageName}"
                    alt="${item.hersteller}"
                    onerror="this.onerror=null; this.src='images/icons/dark/icon-512-blank.webp'"
                  >
                </div>
                
                <div class="cardHeaderTyp">
                  ${item.typ ? `<b> ${item.typ} </b>` : ""} 
                  ${item.code ? `<p> ${item.code} </p>` : ""}
                </div>

              </div>

              <div class="cardContent">
                <div class="errorDescription">
                  <div>
                    ${
                      item.fehler
                        ? `<h4>Fehler: ${item.code}</h4> ${
                            item.kategorie ? `<h5>${item.kategorie}</h5>` : ""
                          } <p>${item.fehler}</p>`
                        : ""
                    }
                  </div>
                  <div>
                    ${
                      item.ursache
                        ? `<h4>Ma√ünahme:</h4><p>${item.ursache}</p>`
                        : ""
                    }
                  </div>
                  <div>
                    ${
                      item.infos
                        ? `<strong>Info:</strong><p>${item.infos}</p>`
                        : ""
                    }
                  </div>
                  <div>
                    ${item.weitere ? `<p>${item.weitere}</p>` : ""}
                  </div>
                </div>

                <div class="typImageWrapper">
                  <img class="typImage" src="${typImagePath}" alt="${
              item.typ
            }" onerror="this.onerror=null; this.src='images/icons/icon-512.png'">
                </div>
              </div>`;

            container.appendChild(card);
          });

        // Theme-Bilder f√ºr neu erzeugte Elemente aktualisieren
        updateThemeAssets(document.body.getAttribute("data-theme"));
      }

      // Aktuallisiert die Bilder passend zum Theme
      function updateThemeAssets(theme) {
        document.querySelectorAll(".theme-image").forEach((img) => {
          const newSrc = img.getAttribute(`data-theme-${theme}`);
          if (newSrc) img.src = newSrc;
        });
      }

      // Versucht CSV Daten aus dem lokalen Speicher zu laden
      function loadData() {
        const savedCSV = localStorage.getItem("csvData");
        if (savedCSV) {
          daten = parseCSV(savedCSV);
          fillDropdowns(daten);
          renderDaten();
          showStatusMessage(
            "Gespeicherte Fehlercodes erfolgreich geladen.",
            "success"
          );
        } else {
          fetch("fehlerliste.csv")
            .then((res) => {
              if (!res.ok) throw new Error("Nicht gefunden");
              return res.text();
            })
            .then((text) => {
              daten = parseCSV(text);
              fillDropdowns(daten);
              renderDaten();
              localStorage.setItem("csvData", text);
              showStatusMessage("Fehlercodes erfolgreich geladen.", "success");
            })
            .catch(() => {
              showStatusMessage(
                "Fehlercodes konnte nicht geladen werden. Bitte unter Optionen manuell laden.",
                "error"
              );
            });
        }
      }

      // Schlie√üt das Men√º
      function closeMenu() {
        document.getElementById("optionDropdown").classList.remove("open");
      }

      // Men√º
      const csvInput = document.getElementById("csvInput");
      const searchInput = document.getElementById("searchInput");
      const herstellerFilter = document.getElementById("herstellerFilter");
      const typFilter = document.getElementById("typFilter");
      const container = document.getElementById("container");
      let daten = [];

      // √ñffnet Men√º bei klick
      document.getElementById("menuToggle").addEventListener("click", () => {
        document.getElementById("optionDropdown").classList.toggle("open");
      });

      // √ñffnet Suchfenster f√ºr Fehlerlisten Datei
      document.getElementById("csvLoadBtn").addEventListener("click", () => {
        csvInput.click();
        closeMenu();
      });

      document.addEventListener("DOMContentLoaded", () => {
        Papa.parse("fehlerliste.csv", {
          download: true,
          header: true,
          complete: function (results) {
            const daten = results.data;
          },
          error: function (err) {
            console.error("Fehler beim Laden der CSV:", err);
          },
        });
      });

      // L√∂scht lokal gespeicherte Daten bei klick
      document.getElementById("resetBtn").addEventListener("click", () => {
        localStorage.removeItem("csvData");
        localStorage.removeItem("theme");
        showStatusMessage(
          "Lokale Daten gel√∂scht ‚Äì Seite wird neu geladen",
          "success"
        );
        setTimeout(() => location.reload(), 1000);
      });

      // √Ñndert das aktuelle Theme bei klick und speichert es lokal
      document
        .getElementById("themeToggleBtn")
        .addEventListener("click", () => {
          const current = document.body.getAttribute("data-theme");
          const newTheme = current === "dark" ? "light" : "dark";
          document.body.setAttribute("data-theme", newTheme);
          localStorage.setItem("theme", newTheme);
          updateThemeAssets(newTheme);
          showStatusMessage("Theme Umgeschaltet und Gespeichert.", "success");
          closeMenu();
        });

      // Schlie√üt das Men√º bei klick ins leere
      document.addEventListener("click", (e) => {
        const menu = document.getElementById("optionDropdown");
        const isClickInside = menu.contains(e.target);
        if (!isClickInside) {
          closeMenu();
        }
      });

      // L√§d gespeichertes Theme
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        document.body.setAttribute("data-theme", savedTheme);
        updateThemeAssets(savedTheme);
        loadData();
      }

      // Lie√üt Fehlerlisten Datei ein und speichert sie lokal
      csvInput.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          const text = event.target.result;
          daten = parseCSV(text);
          localStorage.setItem("csvData", text);
          fillDropdowns(daten);
          renderDaten();
          showStatusMessage(`${file.name} erfolgreich geladen`, "success");
          closeMenu();
        };
        reader.readAsText(file, "UTF-8");
      });

      // Rendert bei Eingaben neu
      [searchInput, herstellerFilter, typFilter].forEach((input) => {
        input.addEventListener("input", debounce(renderDaten, 300));
      });

      // Registriert den Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("‚úÖ Service Worker registriert"))
          .catch((err) => console.error("‚ùå Service Worker Fehler:", err));
      }

      loadData();

      // Scroll nach oben Button
      const scrollTopBtn = document.getElementById("scrollTopBtn");
      window.addEventListener("scroll", () => {
        if (window.scrollY > 300) {
          scrollTopBtn.classList.add("show");
        } else {
          scrollTopBtn.classList.remove("show");
        }
      });
      scrollTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      // Header automatisch ein-/ausblenden beim Scrollen
      let lastScrollY = window.scrollY;
      const headerEl = document.getElementById("siteHeader");
      window.addEventListener("scroll", () => {
        if (window.scrollY > lastScrollY && window.scrollY > 80) {
          headerEl.classList.add("hide");
        } else {
          headerEl.classList.remove("hide");
        }
        lastScrollY = window.scrollY;
      });
    </script>
  </body>
</html>
